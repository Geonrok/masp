"""
ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„±ê¸°
- ê±°ëž˜ ìš”ì•½
- Health ìƒíƒœ
- Markdown ì¶œë ¥
- ì›ìžì  ì €ìž¥ (tmp â†’ replace)
"""

import logging
import os
from datetime import date, datetime
from pathlib import Path
from typing import Any, Dict, Optional

logger = logging.getLogger(__name__)


class DailyReportGenerator:
    """
    ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„±ê¸°

    ì¶œë ¥: logs/reports/daily_YYYY-MM-DD.md
    """

    DEFAULT_REPORT_DIR = "logs/reports"

    def __init__(
        self, trade_logger=None, health_monitor=None, report_dir: Optional[str] = None
    ):
        """ì´ˆê¸°í™”"""
        self.trade_logger = trade_logger
        self.health_monitor = health_monitor
        self.report_dir = Path(report_dir or self.DEFAULT_REPORT_DIR)
        self.report_dir.mkdir(parents=True, exist_ok=True)

    @staticmethod
    def _to_float(v: Any, default: float = 0.0) -> float:
        """ì•ˆì „í•œ float ë³€í™˜"""
        if v is None:
            return default
        if isinstance(v, (int, float)):
            return float(v)
        s = str(v).strip()
        if s == "":
            return default
        try:
            return float(s)
        except (ValueError, TypeError):
            return default

    def generate(self, report_date: Optional[date] = None) -> str:
        """ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„±"""
        d = report_date or date.today()

        trade_summary: Dict = {}
        if self.trade_logger:
            trade_summary = self.trade_logger.get_daily_summary(d)

        health_summary: Dict = {}
        if self.health_monitor:
            if hasattr(self.health_monitor, "get_summary"):
                health_summary = self.health_monitor.get_summary()

        report = self._build_report(d, trade_summary, health_summary)

        # ì›ìžì  ì €ìž¥: tmp â†’ replace
        file_path = self.report_dir / f"daily_{d.strftime('%Y-%m-%d')}.md"
        tmp_path = file_path.with_suffix(".md.tmp")

        try:
            with open(tmp_path, "w", encoding="utf-8") as f:
                f.write(report)
            os.replace(tmp_path, file_path)
            logger.info(f"[DailyReport] Generated: {file_path}")
        except Exception as e:
            logger.error(f"[DailyReport] Save failed: {e}")
            if tmp_path.exists():
                tmp_path.unlink()

        return report

    def _build_report(self, d: date, trades: Dict, health: Dict) -> str:
        """Markdown ë¦¬í¬íŠ¸ ë¹Œë“œ"""

        status = health.get("status", "N/A")
        status_emoji = {
            "HEALTHY": "âœ…",
            "WARNING": "âš ï¸",
            "CRITICAL": "ðŸ”´",
            "HALTED": "â›”",
        }.get(status, "â“")

        mdd = self._to_float(health.get("mdd_pct", 0))
        mdd_status = (
            "ðŸ”´ CRITICAL" if mdd > 15 else ("âš ï¸ WARNING" if mdd > 10 else "âœ… OK")
        )

        triggers = health.get("triggers", [])
        triggers_str = "\n".join(f"- {t}" for t in triggers) if triggers else "- None"

        # ìˆ«ìž ì•ˆì „ ë³€í™˜
        total_trades = int(self._to_float(trades.get("total_trades", 0)))
        buy_count = int(self._to_float(trades.get("buy_count", 0)))
        sell_count = int(self._to_float(trades.get("sell_count", 0)))
        total_volume = self._to_float(trades.get("total_volume", 0))
        total_fee = self._to_float(trades.get("total_fee", 0))
        total_pnl = self._to_float(trades.get("total_pnl", 0))

        report = f"""# Daily Trading Report

**Date**: {d.strftime('%Y-%m-%d')}
**Generated**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

---

## ðŸ“Š Trading Summary

| Metric | Value |
|--------|-------|
| Total Trades | {total_trades} |
| Buy Orders | {buy_count} |
| Sell Orders | {sell_count} |
| Total Volume | {total_volume:,.0f} KRW |
| Total Fees | {total_fee:,.0f} KRW |
| Daily PnL | {total_pnl:+,.0f} KRW |

---

## ðŸ¥ Strategy Health

| Metric | Value | Status |
|--------|-------|--------|
| Status | {status} | {status_emoji} |
| Sharpe (30d) | {health.get('sharpe_30d', 'N/A')} | - |
| MDD | {mdd:.2f}% | {mdd_status} |
| Consecutive Losses | {health.get('consecutive_losses', 0)} | - |

### Triggers
{triggers_str}

### Recommendation
> {health.get('recommendation', 'No data available')}

---

## ðŸ“ Notes

- (Manual notes here)

---

*Generated by MASP v1.0*
"""
        return report

    def print_summary(self, report_date: Optional[date] = None) -> None:
        """ì½˜ì†” ìš”ì•½ ì¶œë ¥"""
        d = report_date or date.today()

        summary: Dict = {}
        if self.trade_logger:
            summary = self.trade_logger.get_daily_summary(d)

        total_trades = int(self._to_float(summary.get("total_trades", 0)))
        buy_count = int(self._to_float(summary.get("buy_count", 0)))
        sell_count = int(self._to_float(summary.get("sell_count", 0)))
        total_volume = self._to_float(summary.get("total_volume", 0))
        total_fee = self._to_float(summary.get("total_fee", 0))
        total_pnl = self._to_float(summary.get("total_pnl", 0))

        print(f"\n{'='*50}")
        print(f"Daily Summary: {d}")
        print(f"{'='*50}")
        print(f"Trades: {total_trades} (B:{buy_count} / S:{sell_count})")
        print(f"Volume: {total_volume:,.0f} KRW")
        print(f"Fees: {total_fee:,.0f} KRW")
        print(f"PnL: {total_pnl:+,.0f} KRW")
        print(f"{'='*50}\n")
